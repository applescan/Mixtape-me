<!DOCTYPE html>
<html lang="en">

<head>
  <title>Mixtapify</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,700&display=swap" rel="stylesheet">
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
</head>

<body>
  <div class="flex-container">



<!--First page-->
<div class="container">
  <div>
    <a href="/login" class="get-started-button spotify-button">Login with Spotify</a>
  </div>


    <div class="loggedin">

      <!--1st section-->   
  
      <div id="user-profile">
      </div>
      <div id="oauth">
      </div>
      <button style="display: none" class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>

      <br>

      <!--Script to show user name-->
      <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Hey there, {{display_name}} ðŸ‘‹</h1>
      <h3>Get started by fetching your top tracks!</h3>
      </script>


      <!--Pick from these timeframes -->
      <div class="timeframes">
      
          <div class="spotify-button" id="get-top-tracks-short-term">Last Month</div>

            <div class="spotify-button" id="get-top-tracks-medium-term">6 Month</div>

            <div class="spotify-button" id="get-top-tracks-long-term">All Time</div>

      </div>

      <br>
      <br>
      

      <!--Top tracks arrays-->
      <div>
        <div id="top-tracks-ShortTerm"></div>
      </div>

      <div>
        <div id="top-tracks-MediumTerm"></div>
      </div>

      <div>
        <div id="top-tracks-LongTerm"></div>
      </div>

    </div>
  </div>


<!--Authorization script-->
<script id="oauth-template" type="text/x-handlebars-template">
</script>
</div>

<!--Library scripts-->
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    

  <script>
    var topTracksShortTerm;
    var topTracksMediumTerm;
    var topTracksLongTerm;

    (function () {

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

//Placing user information to html ids
      var userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

//Placing authorization tokens to html ids
      var oauthSource = document.getElementById('oauth-template').innerHTML,
        oauthTemplate = Handlebars.compile(oauthSource),
        oauthPlaceholder = document.getElementById('oauth');

      var params = getHashParams();

      var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;

        if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {
          // render oauth info
          oauthPlaceholder.innerHTML = oauthTemplate({
            access_token: access_token,
            refresh_token: refresh_token
          });

          $.ajax({
            url: 'https://api.spotify.com/v1/me',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            success: function (response) {
              userProfilePlaceholder.innerHTML = userProfileTemplate(response);

              $('.login').hide();
              $('.loggedin').show();
            }
          });
        } else {
          // render initial screen
          $('.login').show();
          $('.loggedin').hide();
        }

        document.getElementById('obtain-new-token').addEventListener('click', function () {
          $.ajax({
            url: '/refresh_token',
            data: {
              'refresh_token': refresh_token
            }
          }).done(function (data) {
            access_token = data.access_token;
            oauthPlaceholder.innerHTML = oauthTemplate({
              access_token: access_token,
              refresh_token: refresh_token
            });
          });
        }, false);

        if (localStorage.getItem("songsShortTerm") != null) {
          var songsShortTerm = JSON.parse(localStorage.getItem('songsShortTerm'));
          console.log(songsShortTerm);
          mapOverSongsShortTerm(songsShortTerm);
        }

        if (localStorage.getItem("songsMediumTerm") != null) {
          var songsMediumTerm = JSON.parse(localStorage.getItem('songsMediumTerm'));
          console.log(songsMediumTerm);
          mapOverSongsMediumTerm(songsMediumTerm);
        }

        if (localStorage.getItem("songsLongTerm") != null) {
          var songsLongTerm = JSON.parse(localStorage.getItem('songsLongTerm'));
          console.log(songsLongTerm);
          mapOverSongsLongTerm(songsLongTerm);
        }

// Getting top tracks from button click
        document.getElementById('get-top-tracks-short-term').addEventListener('click', function () {
          getTopTracksShortTerm(access_token);
        });

        const seed_tracks_short_term = ['2rmq49FcJ4U3wh1Z7C9UxE,5NdxiycRi3nP2v7RJoAJIT'];


      document.getElementById('get-top-tracks-medium-term').addEventListener('click', function () {
          getTopTracksMediumTerm(access_token);
        });

        const seed_tracks_medium_term = ['2rmq49FcJ4U3wh1Z7C9UxE,5NdxiycRi3nP2v7RJoAJIT'];
      

      document.getElementById('get-top-tracks-long-term').addEventListener('click', function () {
          getTopTracksLongTerm(access_token);
        });

        const seed_tracks_long_term = ['2rmq49FcJ4U3wh1Z7C9UxE,5NdxiycRi3nP2v7RJoAJIT'];
      }

    })();



// Function to get top tracks (store information in JSON file and displaying in html page)
function getTopTracksShortTerm(access_token) {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/top/tracks?time_range=short_term&limit=5',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          $(".recommendations").show();
          topTracksShortTerm = response;

          var songsShortTerm = topTracksShortTerm.items;
          console.log(songsShortTerm);
          localStorage.setItem('songsShortTerm', JSON.stringify(songsShortTerm));
          mapOverSongsShortTerm(songsShortTerm);
        }
      });
    }

function getTopTracksMediumTerm(access_token) {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/top/tracks?time_range=medium_term&limit=5',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          $(".recommendations").show();
          topTracksMediumTerm = response;

          var songsMediumTerm = topTracksMediumTerm.items;
          console.log(songsMediumTerm);
          localStorage.setItem('songsMediumTerm', JSON.stringify(songsMediumTerm));
          mapOverSongsMediumTerm(songsMediumTerm);
        }
      });
    }

function getTopTracksLongTerm(access_token) {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/top/tracks?time_range=long_term&limit=5',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          $(".recommendations").show();
          topTracksLongTerm = response;

          var songsLongTerm = topTracksLongTerm.items;
          console.log(songsLongTerm);
          localStorage.setItem('songsLongTerm', JSON.stringify(songsLongTerm));
          mapOverSongsLongTerm(songsLongTerm);
        }
      });
    }

//Mapping information from spotify to hmtl format 
    function mapOverSongsShortTerm(songsShortTerm) {
      songsShortTerm.map(function (songShortTerm) {
        var list = `
          <div>
          <div class="frame">
          <a target="_blank" href="${songShortTerm.external_urls.spotify}"> 
          <img class="img1" src="/case.png">
          <img class="img2" src="${songShortTerm.album.images[1].url}"></a>
          </div>

          <br>

          <div style="text-align: center;">
          <b>${songShortTerm.name}</b> by
          <b>${songShortTerm.artists[0].name}</b>
          from the album <br>
          <b>${songShortTerm.album.name}</b>
          <br>
          <br> 
          <br>
          </div>
        </div>
          `;

        document.getElementById('top-tracks-ShortTerm').innerHTML += list;
      });
    }

    function mapOverSongsMediumTerm(songsMediumTerm) {
      songsMediumTerm.map(function (songMediumTerm) {
        var list = `
          <div>
          <div class="frame">
          <a target="_blank" href="${songMediumTerm.external_urls.spotify}"> 
          <img class="img1" src="/case.png">
          <img class="img2" src="${songMediumTerm.album.images[1].url}"></a>
          </div>

          <br>

          <div style="text-align: center;">
          <b>${songMediumTerm.name}</b> by
          <b>${songMediumTerm.artists[0].name}</b>
          from the album <br>
          <b>${songMediumTerm.album.name}</b>
          <br>
          <br> 
          <br>
          </div>
        </div>
          `;

        document.getElementById('top-tracks-MediumTerm').innerHTML += list;
      });
    }

    function mapOverSongsLongTerm(songsLongTerm) {
      songsLongTerm.map(function (songLongTerm) {
        var list = `
          <div>
          <div class="frame">
          <a target="_blank" href="${songLongTerm.external_urls.spotify}"> 
          <img class="img1" src="/case.png">
          <img class="img2" src="${songLongTerm.album.images[1].url}"></a>
          </div>

          <br>

          <div style="text-align: center;">
          <b>${songLongTerm.name}</b> by
          <b>${songLongTerm.artists[0].name}</b>
          from the album <br>
          <b>${songLongTerm.album.name}</b>
          <br>
          <br> 
          <br>
          </div>
        </div>
          `;

        document.getElementById('top-tracks-LongTerm').innerHTML += list;
      });
    }
  </script>

</body>

</html>
