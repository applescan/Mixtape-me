<!DOCTYPE html>
<html lang="en">

<head>
  <title>Mixtape-me</title>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon.png" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <!--<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>-->
  <!--<script src="https://cdn.jsdelivr.net/npm/underscore@1.13.6/underscore-umd-min.js"></script>-->
  <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
</head>

<body>

  <div class="flex-container">
    <!--First page-->
    <div class="container">
      <div id="login">
        <!--Top menu-->
        <div class="topnav" id="myTopnav">
          <a href="/" class="active">Home</a>
          <a href="/privacy">Privacy Policy</a>
          <a href="/contact">Contact</a>
          <a href="/about">About</a>
          <a href="/logout">Logout</a>
        </div>

        <!--App logo-->
        <a href="/"><img src="logo.png" class="logo" alt="Logo"></a>
        <p>
          Throwback to the 90's with Mixtape-me! Share your top 5 songs in a
          mixtape form ðŸ’¿
        </p>
        <a href="/login" class="login-spotify-button">Login with Spotify</a>

        <!--Footer-->
        <footer>
          <img src="spotify.png" alt="Logo" style="height: 40px; margin-bottom: 10px" />
          <p>
            Created by
            <a target="_blank" href="https://www.feliciadigitaldesign.art/"><u>Felicia Fel</u></a>
            | Â© Mixtape-me 2023 ðŸš€
          </p>
        </footer>
      </div>

      <div id="loggedin">

        <!--Top menu-->
        <div class="topnav" id="myTopnav">
          <a href="/">Home</a>
          <a href="/privacy">Privacy Policy</a>
          <a href="/contact">Contact</a>
          <a href="/about">About</a>
          <a href="/logout">Logout</a>
        </div>

        <!--1st section-->

        <div id="user-profile"></div>
        <div id="oauth"></div>

        <button style="display: none" class="btn btn-default" id="obtain-new-token">
          Obtain new token using the refresh token
        </button>

        <br />

        <!--Script to show user name-->
        <script id="user-profile-template" type="text/x-handlebars-template">
            <br>
            <br>
            <br>
            <br>
            <a href="/" ><img src="logo.png" alt="Logo" class="logo"></a>
            <h2>Hey there, {{display_name}}ðŸ‘‹</h2>
            <h4>Get started by fetching your top tracks, Click the save button to save this and share your mixtape! ðŸ”—</h4>
          </script>
        <button id="button" class="takepic-button">[ Ê• â€¢á´¥â€¢Ê” Save Image ]</button>
        <br>
        <br>


        <!--Pick from these timeframes -->
        <div class="timeframes">
          <label for="div1" class="spotify-button" id="get-top-tracks-short-term">Last Month</label>
          <label for="div2" class="spotify-button" id="get-top-tracks-medium-term">6 Month</label>
          <label for="div3" class="spotify-button" id="get-top-tracks-long-term">All Time</label>
        </div>

        <br />
        <br />

        <!--Top tracks arrays-->

        <div id="capture" style="background-image:url('bg.jpg')">
          <section>
            <input type="radio" id="div1" name="tab-nav" checked />
            <div class="display">
              <div id="top-tracks-ShortTerm"></div>
            </div>
          </section>

          <section>
            <input type="radio" id="div2" name="tab-nav" />
            <div class="display">
              <div id="top-tracks-MediumTerm"></div>
            </div>
          </section>

          <section>
            <input type="radio" id="div3" name="tab-nav" />
            <div class="display">
              <div id="top-tracks-LongTerm"></div>
            </div>
          </section>

          <a href="/"><img src="logo.png" alt="Logo" style="height: 40px;" /></a>
          <span> X </span>
          <!--Footer-->
          <img src="spotify.png" alt="Logo" style="height: 30px; margin-bottom: 10px" />
          <p style="color: #fff;">
            Created by
            <a target="_blank" href="https://www.feliciadigitaldesign.art/"><u>Felicia Fel</u></a>
            | Â© Mixtape-me 2023 ðŸš€
          </p>
          <br>
        </div>
      </div>

      <!--Authorization script-->
      <script id="oauth-template" type="text/x-handlebars-template"></script>
    </div>


    <script>
      var topTracksShortTerm;
      var topTracksMediumTerm;
      var topTracksLongTerm;

      (function () {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e,
            r = /([^&;=]+)=?([^&;]*)/g,
            q = window.location.hash.substring(1);
          while ((e = r.exec(q))) {
            hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        //Placing user information to html ids
        var userProfileSource = document.getElementById(
          "user-profile-template"
        ).innerHTML,
          userProfileTemplate = Handlebars.compile(userProfileSource),
          userProfilePlaceholder = document.getElementById("user-profile");

        //Placing authorization tokens to html ids
        var oauthSource = document.getElementById("oauth-template").innerHTML,
          oauthTemplate = Handlebars.compile(oauthSource),
          oauthPlaceholder = document.getElementById("oauth");

        var params = getHashParams();

        var access_token = params.access_token,
          refresh_token = params.refresh_token,
          error = params.error;

        if (error) {
          alert("There was an error during the authentication");
        } else {
          if (access_token) {
            $.ajax({
              url: "https://api.spotify.com/v1/me",
              headers: {
                Authorization: "Bearer " + access_token,
              },
              success: function (response) {
                userProfilePlaceholder.innerHTML =
                  userProfileTemplate(response);

                $("#login").hide();
                $("#loggedin").show();
                getTopTracksShortTerm(access_token);
                getTopTracksMediumTerm(access_token);
                getTopTracksLongTerm(access_token);
              },
            });
          } else {
            // render initial screen
            $("#login").show();
            $("#loggedin").hide();
          }

          if (localStorage.getItem("songsShortTerm") != null) {
            var songsShortTerm = JSON.parse(
              localStorage.getItem("songsShortTerm")
            );
            console.log(songsShortTerm);
            mapOverSongsShortTerm(songsShortTerm);
          }

          if (localStorage.getItem("songsMediumTerm") != null) {
            var songsMediumTerm = JSON.parse(
              localStorage.getItem("songsMediumTerm")
            );
            console.log(songsMediumTerm);
            mapOverSongsMediumTerm(songsMediumTerm);
          }

          if (localStorage.getItem("songsLongTerm") != null) {
            var songsLongTerm = JSON.parse(
              localStorage.getItem("songsLongTerm")
            );
            console.log(songsLongTerm);
            mapOverSongsLongTerm(songsLongTerm);
          }
        }
      })();

      // Function to get top tracks (store information in JSON file and displaying in html page)
      function getTopTracksShortTerm(access_token) {
        $.ajax({
          url: "https://api.spotify.com/v1/me/top/tracks?time_range=short_term&limit=5",
          headers: {
            Authorization: "Bearer " + access_token,
          },
          success: function (response) {
            topTracksShortTerm = response;

            var songsShortTerm = topTracksShortTerm.items;
            console.log(songsShortTerm);
            localStorage.setItem(
              "songsShortTerm",
              JSON.stringify(songsShortTerm)
            );
            mapOverSongsShortTerm(songsShortTerm);
          },
        });
      }

      function getTopTracksMediumTerm(access_token) {
        $.ajax({
          url: "https://api.spotify.com/v1/me/top/tracks?time_range=medium_term&limit=5",
          headers: {
            Authorization: "Bearer " + access_token,
          },
          success: function (response) {
            topTracksMediumTerm = response;

            var songsMediumTerm = topTracksMediumTerm.items;
            console.log(songsMediumTerm);
            localStorage.setItem(
              "songsMediumTerm",
              JSON.stringify(songsMediumTerm)
            );
            mapOverSongsMediumTerm(songsMediumTerm);
          },
        });
      }

      function getTopTracksLongTerm(access_token) {
        $.ajax({
          url: "https://api.spotify.com/v1/me/top/tracks?time_range=long_term&limit=5",
          headers: {
            Authorization: "Bearer " + access_token,
          },
          success: function (response) {
            topTracksLongTerm = response;

            var songsLongTerm = topTracksLongTerm.items;
            console.log(songsLongTerm);
            localStorage.setItem(
              "songsLongTerm",
              JSON.stringify(songsLongTerm)
            );
            mapOverSongsLongTerm(songsLongTerm);
          },
        });
      }

      //Mapping information from spotify to hmtl format
      function mapOverSongsShortTerm(songsShortTerm) {
        songsShortTerm.map(function (songShortTerm) {
          var list = `
          <div class="cd">
          <div class="frame">
          <a target="_blank" href="${songShortTerm.external_urls.spotify}"> 
          <img class="img2" src="${songShortTerm.album.images[1].url}"></a>
          </div>

          <br>

          <div style="text-align: center;">
          <b>${songShortTerm.name}</b> by
          <b>${songShortTerm.artists[0].name}</b>
          from the album <br>
          <b>${songShortTerm.album.name}</b>
          <br>
          <br> 
          <br>
          </div>
        </div>
          `;

          document.getElementById("top-tracks-ShortTerm").innerHTML += list;
        });
      }

      function mapOverSongsMediumTerm(songsMediumTerm) {
        songsMediumTerm.map(function (songMediumTerm) {
          var list = `
          <div class="cd">
          <div class="frame">
          <a target="_blank" href="${songMediumTerm.external_urls.spotify}"> 
          <img class="img2" src="${songMediumTerm.album.images[1].url}"></a>
          </div>

          <br>

          <div style="text-align: center;">
          <b>${songMediumTerm.name}</b> by
          <b>${songMediumTerm.artists[0].name}</b>
          from the album <br>
          <b>${songMediumTerm.album.name}</b>
          <br>
          <br> 
          <br>
          </div>
        </div>
          `;

          document.getElementById("top-tracks-MediumTerm").innerHTML += list;
        });
      }

      function mapOverSongsLongTerm(songsLongTerm) {
        songsLongTerm.map(function (songLongTerm) {
          var list = `
          <div class="cd">
          <div class="frame">
          <a target="_blank" href="${songLongTerm.external_urls.spotify}"> 
          <img class="img2" src="${songLongTerm.album.images[1].url}"></a>
          </div>

          <br>

          <div style="text-align: center;">
          <b>${songLongTerm.name}</b> by
          <b>${songLongTerm.artists[0].name}</b>
          from the album <br>
          <b>${songLongTerm.album.name}</b>
          <br>
          <br> 
          <br>
          </div>
        </div>
          `;

          document.getElementById("top-tracks-LongTerm").innerHTML += list;
        });
      }
    </script>

    <!--Script for dom-to-image-->
    <script>
      $(document).ready(function () {
        $("#button").click(function () {
          domtoimage.toBlob(document.getElementById('capture'))
            .then(function (blob) {
              window.saveAs(blob, "Mixtape-me.jpg")
            })
        })
      })
    </script>

</body>

</html>